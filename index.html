<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deep Traders : By Dhaliwal</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3081/3081648.png">

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        body { font-family: sans-serif; background: #f1f5f9; margin: 0; padding: 10px; color: #334155; }
        .app { max-width: 800px; margin: 0 auto; background: #fff; padding: 15px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        header { text-align: center; border-bottom: 2px solid #eee; margin-bottom: 15px; padding-bottom: 10px; }
        h1 { margin: 0; font-size: 20px; text-transform: uppercase; color: #0f172a; }
        
        /* Dashboard */
        .dashboard { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .dash-card { background: #f8fafc; padding: 10px; border-radius: 10px; text-align: center; border: 1px solid #ddd; }
        .dash-val { font-size: 13px; font-weight: bold; color: #0f172a; }
        .dash-lbl { font-size: 9px; color: #64748b; text-transform: uppercase; }

        /* Navigation */
        .actions { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 15px; }
        .btn { border: none; padding: 10px; border-radius: 10px; color: white; cursor: pointer; font-size: 8.5px; font-weight: bold; display: flex; flex-direction: column; align-items: center; transition: 0.2s; }
        .btn:active { transform: scale(0.95); }
        .b-scan { background: #f97316; } .b-add { background: #3b82f6; } .b-items { background: #64748b; } .b-barcode { background: #8b5cf6; } .b-data { background: #059669; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #1e293b; color: white; padding: 8px; font-size: 11px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; }
        input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 14px; }

        /* Totals */
        .totals { background: #1e293b; color: white; padding: 15px; border-radius: 12px; margin-top: 15px; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; align-items: center; }
        .total-row input { width: 80px; padding: 4px; border-radius: 4px; border: none; text-align: right; color: #000; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 95%; max-width: 500px; padding: 20px; border-radius: 15px; position: relative; max-height: 80vh; overflow-y: auto; }
        .close-btn { position: absolute; right: 15px; top: 15px; font-size: 24px; color: red; cursor: pointer; }

        /* Print Media */
        #print-labels-area, #print-receipt-area { display: none; }
        @media print {
            .app, .modal { display: none !important; }
            body { background: white; }
            body.print-labels #print-labels-area { display: grid !important; grid-template-columns: repeat(3, 64mm); grid-auto-rows: 34mm; gap: 2mm; padding: 10mm; }
            .sticker { width: 64mm; height: 34mm; border: 0.1mm dotted #ccc; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; page-break-inside: avoid; }
            svg.barcode-img { width: 90%; height: 15mm !important; }
            body.print-receipt #print-receipt-area { display: block !important; padding: 40px; font-family: monospace; }
            .bill-head { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
            .unpaid-mark { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 70px; color: rgba(0,0,0,0.05); font-weight: bold; border: 10px solid rgba(0,0,0,0.05); padding: 20px; pointer-events: none; }
        }
    </style>
</head>
<body>

<div class="app">
    <header>
        <h1>Deep Traders : By Dhaliwal</h1>
        <p style="font-size:11px; color:#64748b; margin:5px 0;">Ludhiana Wholesale | Contact: 97796-79885</p>
        <div class="ord-tag" id="dispID">ORD-000000</div>
    </header>

    <div class="dashboard">
        <div class="dash-card"><div class="dash-lbl">Today</div><div class="dash-val" id="dsToday">‚Çπ0</div></div>
        <div class="dash-card"><div class="dash-lbl">Pending</div><div class="dash-val" id="dsPending">‚Çπ0</div></div>
        <div class="dash-card"><div class="dash-lbl">Total Sales</div><div class="dash-val" id="dsTotal">‚Çπ0</div></div>
    </div>

    <div class="actions">
        <button class="btn b-scan" onclick="startScan()">üì∑ SCAN</button>
        <button class="btn b-add" onclick="openPick()">üì¶ ADD</button>
        <button class="btn b-items" onclick="openMgr()">‚öôÔ∏è ITEMS</button>
        <button class="btn b-barcode" onclick="printStickers()">üè∑Ô∏è BARCODE</button>
        <button class="btn b-data" onclick="openData()">üíæ DATA</button>
    </div>

    <div style="background:#f8fafc; padding:12px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:8px;">
            <input type="text" id="cName" placeholder="Customer Name">
            <input type="tel" id="cPhone" placeholder="Mobile Number">
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:8px;">
            <input type="text" id="cCity" placeholder="City/Address">
            <input type="date" id="oDate">
        </div>
        <select id="pStat" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc;" onchange="updateDash()">
            <option value="Pending">Payment: Pending</option>
            <option value="Paid">Payment: Paid</option>
        </select>
    </div>

    <div style="overflow-x:auto;">
        <table>
            <thead><tr><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th><th></th></tr></thead>
            <tbody id="billBody"></tbody>
        </table>
    </div>

    <div class="totals">
        <div class="total-row"><span>Discount (-)</span><input type="number" id="iDisc" value="0" oninput="calc()"></div>
        <div class="total-row"><span>Packing (+)</span><input type="number" id="iPack" value="0" oninput="calc()"></div>
        <div style="display:flex; justify-content:space-between; border-top:1px solid #555; padding-top:10px; margin-top:5px;">
            <span>Qty: <b id="oQty">0</b></span>
            <span>Total: <b style="font-size:18px; color:#4ade80;">‚Çπ <span id="oGrand">0</span></b></span>
        </div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:8px; margin-top:15px;">
        <button class="btn" style="background:#64748b; padding:12px; font-size:11px;" onclick="resetForm()">NEW</button>
        <button class="btn" style="background:#0ea5e9; padding:12px; font-size:11px;" onclick="saveOrder()">SAVE</button>
        <button class="btn" style="background:#22c55e; padding:12px; font-size:11px;" onclick="sendWA()">WA</button>
        <button class="btn" style="background:#0f172a; padding:12px; font-size:11px;" onclick="printBill()">BILL</button>
    </div>
</div>

<div id="modalMgr" class="modal"><div class="modal-box"><span class="close-btn" onclick="closeM('modalMgr')">√ó</span><h3>Manage Inventory</h3><div style="background:#f1f5f9; padding:10px; border-radius:10px; margin-bottom:10px;"><input id="nItem" placeholder="Name" style="margin-bottom:5px;"><input id="nSize" placeholder="Size" style="margin-bottom:5px;"><input type="number" id="nRate" placeholder="Rate" style="margin-bottom:10px;"><button id="btnSaveItem" onclick="addItem()" style="width:100%; padding:10px; background:#22c55e; color:white; border:none; border-radius:5px; font-weight:bold;">Add Item</button></div><div id="mgrList"></div></div></div>
<div id="modalPick" class="modal"><div class="modal-box"><span class="close-btn" onclick="closeM('modalPick')">√ó</span><h3>Select Product</h3><input type="text" placeholder="Search..." onkeyup="filterPick(this.value)" style="margin-bottom:10px;"><div id="pickList"></div></div></div>
<div id="modalHist" class="modal"><div class="modal-box"><span class="close-btn" onclick="closeM('modalHist')">√ó</span><h3>Order History</h3><input type="text" placeholder="Search orders..." onkeyup="filterHist(this.value)" style="margin-bottom:10px;"><div id="histList"></div></div></div>
<div id="modalData" class="modal"><div class="modal-box"><span class="close-btn" onclick="closeM('modalData')">√ó</span><h3>Data Management</h3><button onclick="exportData()" style="width:100%; padding:12px; background:#0ea5e9; color:white; border:none; border-radius:8px; margin-bottom:15px; font-weight:bold;">üì• Export to Pen Drive</button><p style="font-size:12px;">Restore from backup:</p><input type="file" onchange="importData(this)"></div></div>
<div id="modalScan" class="modal"><div class="modal-box" style="background:#000; padding:0;"><span class="close-btn" onclick="stopScan()" style="color:white; z-index:1100;">√ó</span><div id="scanBox"></div></div></div>

<div id="print-labels-area"></div>
<div id="print-receipt-area"></div>

<script>
    let db = JSON.parse(localStorage.getItem('dh_db')) || [];
    let orders = JSON.parse(localStorage.getItem('dh_orders')) || [];
    let editingItemCode = null;

    function sync() { localStorage.setItem('dh_db', JSON.stringify(db)); localStorage.setItem('dh_orders', JSON.stringify(orders)); updateDash(); }

    function resetForm() {
        document.getElementById('dispID').innerText = 'ORD-' + Math.floor(Math.random()*900000+100000);
        document.getElementById('cName').value = ''; document.getElementById('cPhone').value = ''; document.getElementById('cCity').value = '';
        document.getElementById('iDisc').value = 0; document.getElementById('iPack').value = 0;
        document.getElementById('oDate').valueAsDate = new Date();
        document.getElementById('billBody').innerHTML = '';
        addRow(); calc();
    }

    function addRow(d={code:'', name:'', qty:1, rate:0}) {
        let tr = document.createElement('tr');
        tr.innerHTML = `<td><small style="color:#64748b">${d.code}</small><br><input class="r-name" value="${d.name}"></td><td><input type="number" class="r-qty" value="${d.qty}" oninput="calc()"></td><td><input type="number" class="r-rate" value="${d.rate}" oninput="calc()"></td><td class="r-tot" style="font-weight:bold">0</td><td><button onclick="this.closest('tr').remove();calc()" style="color:red; background:none; border:none; font-size:18px;">√ó</button></td>`;
        document.getElementById('billBody').appendChild(tr);
        calc();
    }

    function calc() {
        let q=0, t=0;
        document.querySelectorAll('#billBody tr').forEach(r => {
            let nq = +r.querySelector('.r-qty').value || 0, nr = +r.querySelector('.r-rate').value || 0;
            let nt = nq * nr; r.querySelector('.r-tot').innerText = nt;
            q += nq; t += nt;
        });
        let grand = t - (+document.getElementById('iDisc').value) + (+document.getElementById('iPack').value);
        document.getElementById('oQty').innerText = q;
        document.getElementById('oGrand').innerText = grand.toLocaleString('en-IN');
    }

    /* INVENTORY */
    function addItem() {
        let n = document.getElementById('nItem').value, r = document.getElementById('nRate').value, s = document.getElementById('nSize').value;
        if(!n || !r) return alert("Enter Name and Rate");
        if(editingItemCode) {
            let idx = db.findIndex(i => i.code === editingItemCode);
            db[idx] = { code: editingItemCode, name: n, size: s, rate: r };
            editingItemCode = null;
            document.getElementById('btnSaveItem').innerText = "Add Item";
        } else {
            db.push({code: Math.random().toString(36).substr(2,6).toUpperCase(), name: n, size: s, rate: r});
        }
        sync(); renderMgr();
        document.getElementById('nItem').value = ''; document.getElementById('nRate').value = ''; document.getElementById('nSize').value = '';
    }

    function renderMgr() {
        document.getElementById('mgrList').innerHTML = db.map((i,idx) => `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;"><div><b>${i.name}</b><br><small>${i.code} | Size: ${i.size} | ‚Çπ${i.rate}</small></div><div><button onclick="editItem('${i.code}')" style="color:#3b82f6; border:none; background:none; font-weight:bold; margin-right:10px;">Edit</button><button onclick="if(confirm('Delete?')){db.splice(${idx},1);sync();renderMgr()}" style="color:red; border:none; background:none;">Del</button></div></div>`).join('');
    }

    function editItem(code) {
        let itm = db.find(i => i.code === code);
        document.getElementById('nItem').value = itm.name; document.getElementById('nSize').value = itm.size; document.getElementById('nRate').value = itm.rate;
        editingItemCode = code; document.getElementById('btnSaveItem').innerText = "Update Item";
    }

    /* HISTORY & PICK */
    function filterPick(val) {
        let filtered = db.filter(i => i.name.toLowerCase().includes(val.toLowerCase()) || i.code.toLowerCase().includes(val.toLowerCase()));
        document.getElementById('pickList').innerHTML = filtered.map(i => `<div onclick="addRow({code:'${i.code}', name:'${i.name}', qty:1, rate:'${i.rate}'});closeM('modalPick')" style="padding:15px; border-bottom:1px solid #eee; cursor:pointer;">${i.name} (${i.size}) - ‚Çπ${i.rate}</div>`).join('');
    }

    function saveOrder() {
        let items = [];
        document.querySelectorAll('#billBody tr').forEach(r => {
            if(r.querySelector('.r-name').value) items.push({name: r.querySelector('.r-name').value, qty: r.querySelector('.r-qty').value, rate: r.querySelector('.r-rate').value});
        });
        let order = { id: document.getElementById('dispID').innerText, date: document.getElementById('oDate').value, name: document.getElementById('cName').value, phone: document.getElementById('cPhone').value, city: document.getElementById('cCity').value, disc: document.getElementById('iDisc').value, pack: document.getElementById('iPack').value, items, total: document.getElementById('oGrand').innerText, status: document.getElementById('pStat').value };
        let idx = orders.findIndex(o => o.id === order.id);
        if(idx > -1) orders[idx] = order; else orders.unshift(order);
        sync(); alert("Order Saved!");
    }

    function filterHist(val) {
        let filtered = orders.filter(o => o.name.toLowerCase().includes(val.toLowerCase()) || o.id.toLowerCase().includes(val.toLowerCase()));
        document.getElementById('histList').innerHTML = filtered.map(o => `<div style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;"><div><b>${o.name}</b><br><small>${o.id} | ‚Çπ${o.total} | ${o.status}</small></div><div><button onclick="loadOrder('${o.id}')" style="background:#3b82f6; color:white; border:none; padding:5px 10px; border-radius:4px; font-size:11px;">Edit Bill</button><button onclick="if(confirm('Delete order?')){orders = orders.filter(x=>x.id!=='${o.id}');sync();filterHist('${val}')}" style="margin-left:10px; color:red; border:none; background:none;">Del</button></div></div>`).join('');
    }

    function loadOrder(id) {
        let o = orders.find(x => x.id === id);
        document.getElementById('dispID').innerText = o.id; document.getElementById('cName').value = o.name; document.getElementById('cPhone').value = o.phone || ''; document.getElementById('cCity').value = o.city || '';
        document.getElementById('oDate').value = o.date; document.getElementById('pStat').value = o.status; document.getElementById('iDisc').value = o.disc || 0; document.getElementById('iPack').value = o.pack || 0;
        document.getElementById('billBody').innerHTML = ''; o.items.forEach(i => addRow(i));
        calc(); closeM('modalHist');
    }

    /* PRINTING */
    function printStickers() {
        if(db.length === 0) return alert("Add items first!");
        let area = document.getElementById('print-labels-area');
        area.innerHTML = db.map(i => `<div class="sticker"><b>${i.name}</b><svg class="barcode-img" jsbarcode-value="${i.code}"></svg><span>Size: ${i.size} | ‚Çπ${i.rate}</span></div>`).join('');
        JsBarcode(".barcode-img", { format: "CODE128", height: 35, width: 2, displayValue: true, fontSize: 14 }).init();
        document.body.className = 'print-labels'; window.print();
        setTimeout(() => document.body.className = '', 500);
    }

    function printBill() {
        let itemsHtml = Array.from(document.querySelectorAll('#billBody tr')).map(r => `<tr><td>${r.querySelector('.r-name').value}</td><td>${r.querySelector('.r-qty').value}</td><td>${r.querySelector('.r-rate').value}</td><td>${r.querySelector('.r-tot').innerText}</td></tr>`).join('');
        document.getElementById('print-receipt-area').innerHTML = `<div class="bill-head"><h2>Deep Traders : By Dhaliwal</h2><p>Ludhiana | 97796-79885</p></div>${document.getElementById('pStat').value === 'Pending' ? '<div class="unpaid-mark">UNPAID</div>' : ''}<p><b>Party:</b> ${document.getElementById('cName').value} | <b>Mob:</b> ${document.getElementById('cPhone').value}<br><b>Address:</b> ${document.getElementById('cCity').value} | <b>Date:</b> ${document.getElementById('oDate').value}</p><table border="1" style="width:100%; border-collapse:collapse;"><thead><tr style="background:#f1f5f9"><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th></tr></thead><tbody>${itemsHtml}</tbody></table><div style="text-align:right; margin-top:20px;">Subtotal: ‚Çπ ${document.getElementById('oGrand').innerText}<br>Discount: - ‚Çπ ${document.getElementById('iDisc').value}<br>Packing: + ‚Çπ ${document.getElementById('iPack').value}<br><h3 style="margin-top:5px;">Grand Total: ‚Çπ ${document.getElementById('oGrand').innerText}</h3></div><p style="text-align:center; font-size:12px; margin-top:30px; border-top:1px solid #000; padding-top:10px;">Computer Generated Invoice - No Signature Required<br><b>Goods once sold will not be taken back.</b><br>Subject to Ludhiana Jurisdiction.</p>`;
        document.body.className = 'print-receipt'; window.print();
        setTimeout(() => document.body.className = '', 500);
    }

    function sendWA() {
        let n = document.getElementById('cName').value; let p = document.getElementById('cPhone').value; if(!n) return alert("Enter Name");
        let itmTxt = ""; document.querySelectorAll('#billBody tr').forEach(r => { if(r.querySelector('.r-name').value) itmTxt += `%0A‚Ä¢ ${r.querySelector('.r-name').value} (${r.querySelector('.r-qty').value}pcs)`; });
        let msg = `*DEEP TRADERS : BY DHALIWAL*%0AOrder No: ${document.getElementById('dispID').innerText}%0A------------------------%0AParty: ${n}${itmTxt}%0A------------------------%0A*GRAND TOTAL: ‚Çπ${document.getElementById('oGrand').innerText}*%0AStatus: ${document.getElementById('pStat').value}`;
        window.open(`https://wa.me/${p.startsWith('91')?p:'91'+p}?text=${msg}`);
    }

    function updateDash() {
        document.getElementById('dsTotal').innerText = '‚Çπ' + orders.reduce((s,o) => s + +o.total.replace(/,/g,''), 0).toLocaleString('en-IN');
        document.getElementById('dsPending').innerText = '‚Çπ' + orders.filter(o => o.status === 'Pending').reduce((s,o) => s + +o.total.replace(/,/g,''), 0).toLocaleString('en-IN');
        document.getElementById('dsToday').innerText = '‚Çπ' + orders.filter(o => o.date === new Date().toISOString().split('T')[0]).reduce((s,o) => s + +o.total.replace(/,/g,''), 0).toLocaleString('en-IN');
    }

    function exportData() { let blob = new Blob([JSON.stringify({db, orders})], {type: 'application/json'}); let a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'deep_traders_backup.json'; a.click(); }
    function importData(inp) { let reader = new FileReader(); reader.onload = e => { let d = JSON.parse(e.target.result); db = d.db; orders = d.orders; sync(); location.reload(); }; reader.readAsText(inp.files[0]); }
    function openData() { document.getElementById('modalData').style.display='flex'; }
    function openMgr() { document.getElementById('modalMgr').style.display='flex'; renderMgr(); }
    function openPick() { document.getElementById('modalPick').style.display='flex'; filterPick(''); }
    function openHist() { document.getElementById('modalHist').style.display='flex'; filterHist(''); }
    function closeM(id) { document.getElementById(id).style.display='none'; editingItemCode = null; }
    let scanner = null;
    function startScan() { document.getElementById('modalScan').style.display='flex'; if(!scanner) { scanner = new Html5QrcodeScanner("scanBox", { fps: 15, qrbox: 250 }); scanner.render(res => { let itm = db.find(i => i.code === res); if(itm) addRow({code: itm.code, name: itm.name, qty: 1, rate: itm.rate}); }); } }
    function stopScan() { document.getElementById('modalScan').style.display='none'; if(scanner) { scanner.clear(); scanner=null; } }
    resetForm(); updateDash();
</script>
</body>
</html>

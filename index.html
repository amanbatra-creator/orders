<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Deep Traders : By Dhaliwal</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f1f5f9; margin: 0; padding: 10px; color: #334155; }
        .app { max-width: 800px; margin: 0 auto; background: #fff; padding: 15px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        header { text-align: center; border-bottom: 2px solid #eee; margin-bottom: 15px; padding-bottom: 10px; }
        .actions { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .btn { border: none; padding: 15px 5px; border-radius: 12px; color: white; cursor: pointer; font-size: 11px; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; transition: 0.1s; }
        .btn:active { transform: scale(0.95); }
        .b-scan { background: #f97316; } .b-add { background: #3b82f6; } .b-items { background: #64748b; }
        .b-hist { background: #ef4444; } .b-barcode { background: #8b5cf6; } .b-data { background: #059669; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 5px; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #1e293b; color: white; padding: 8px; font-size: 11px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 95%; max-width: 500px; padding: 20px; border-radius: 15px; max-height: 85vh; overflow-y: auto; position: relative; }
        .edit-btn { background: #2563eb; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 11px; }
        .del-btn { background: #ef4444; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 11px; margin-left: 5px; }
        .totals { background: #1e293b; color: white; padding: 15px; border-radius: 12px; margin-top: 15px; }
        #print-labels-area, #print-receipt-area { display: none; }
        @media print {
            .app, .modal { display: none !important; }
            body.print-labels #print-labels-area { display: grid !important; grid-template-columns: repeat(3, 64mm); grid-auto-rows: 34mm; gap: 2mm; padding: 10mm; }
            .sticker { width: 64mm; height: 34mm; border: 0.1mm dotted #ccc; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
            svg.barcode-img { width: 90%; height: 15mm !important; }
            body.print-receipt #print-receipt-area { display: block !important; padding: 40px; font-family: monospace; }
        }
    </style>
</head>
<body>
<div class="app">
    <header>
        <h1 style="font-size:20px; margin:0;">Deep Traders : By Dhaliwal</h1>
        <p style="font-size:11px; color:#64748b; margin:5px 0;">Ludhiana Wholesale | 97796-79885</p>
        <div id="dispID" style="background:#e0f2fe; color:#0284c7; padding:5px 10px; border-radius:5px; font-weight:bold; display:inline-block;">ORD-000000</div>
    </header>
    <div class="actions">
        <button class="btn b-scan" onclick="startScan()">üì∑ SCAN</button>
        <button class="btn b-add" onclick="openPick()">üì¶ ADD</button>
        <button class="btn b-items" onclick="openMgr()">‚öôÔ∏è ITEMS</button>
        <button class="btn b-hist" onclick="openHist()">üìú HIST</button>
        <button class="btn b-barcode" onclick="printStickers()">üè∑Ô∏è BARCODE</button>
        <button class="btn b-data" onclick="openData()">üíæ DATA</button>
    </div>
    <div style="background:#f8fafc; padding:12px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:15px;">
        <input type="text" id="cName" placeholder="Customer Name">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;"><input type="tel" id="cPhone" placeholder="Mobile No"><input type="text" id="cCity" placeholder="City"></div>
        <input type="date" id="oDate"><select id="pStat"><option value="Pending">Payment: Pending</option><option value="Paid">Payment: Paid</option></select>
    </div>
    <table style="width:100%;"><thead style="background:#1e293b; color:white;"><tr><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th><th></th></tr></thead><tbody id="billBody"></tbody></table>
    <div class="totals">
        <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:13px; align-items:center;"><span>1# Discount (-)</span><input type="number" id="iDisc" value="0" style="width:80px; padding:5px; border:none; text-align:right;" oninput="calc()"></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:13px; align-items:center;"><span>2# Packing/Hand. (+)</span><input type="number" id="iPack" value="0" style="width:80px; padding:5px; border:none; text-align:right;" oninput="calc()"></div>
        <div style="display:flex; justify-content:space-between; border-top:1px solid #444; padding-top:10px;"><span>Qty: <b id="oQty">0</b></span><span>Grand Total: <b style="font-size:20px; color:#4ade80;">‚Çπ <span id="oGrand">0</span></b></span></div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px; margin-top:15px;">
        <button class="btn" style="background:#64748b; padding:12px;" onclick="resetForm()">+ NEW</button>
        <button class="btn" style="background:#0ea5e9; padding:12px;" onclick="saveOrder()">üíæ SAVE</button>
        <button class="btn" style="background:#22c55e; padding:12px;" onclick="sendWA()">üí¨ WA</button>
        <button class="btn" style="background:#0f172a; padding:12px;" onclick="printBill()">üßæ BILL</button>
    </div>
</div>
<div id="modalMgr" class="modal"><div class="modal-box"><h3>Inventory</h3><div style="background:#f1f5f9; padding:10px; border-radius:10px;"><input id="nItem" placeholder="Name"><input id="nSize" placeholder="Size"><input type="number" id="nRate" placeholder="Price"><button id="btnSaveItem" onclick="addItem()" style="width:100%; padding:10px; background:#22c55e; color:white; border:none; border-radius:5px; font-weight:bold;">ADD/UPDATE</button></div><div id="mgrList" style="margin-top:10px;"></div><button onclick="closeM('modalMgr')" style="width:100%; margin-top:10px;">Close</button></div></div>
<div id="modalHist" class="modal"><div class="modal-box"><h3>Order History</h3><input type="text" placeholder="Search orders..." onkeyup="filterHist(this.value)"><div id="histList"></div><button onclick="closeM('modalHist')" style="width:100%; margin-top:10px;">Close</button></div></div>
<div id="modalPick" class="modal"><div class="modal-box"><h3>Select Product</h3><div id="pickList"></div><button onclick="closeM('modalPick')" style="width:100%; margin-top:10px;">Close</button></div></div>
<div id="modalData" class="modal"><div class="modal-box"><h3>Data Backup</h3><button onclick="exportData()" style="width:100%; padding:15px; background:#0ea5e9; color:white; border:none; border-radius:10px; font-weight:bold;">üì• DOWNLOAD BACKUP</button><br><br><input type="file" onchange="importData(this)"><button onclick="closeM('modalData')" style="width:100%; margin-top:10px;">Close</button></div></div>
<div id="modalScan" class="modal"><div class="modal-box" style="background:#000; padding:0;"><div id="scanBox"></div><button onclick="stopScan()" style="color:white; width:100%; padding:10px; background:red; border:none;">Close Camera</button></div></div>
<div id="print-labels-area"></div><div id="print-receipt-area"></div>
<script>
    let db = JSON.parse(localStorage.getItem('dh_db')) || [];
    let orders = JSON.parse(localStorage.getItem('dh_orders')) || [];
    let editingItemCode = null;
    function sync() { localStorage.setItem('dh_db', JSON.stringify(db)); localStorage.setItem('dh_orders', JSON.stringify(orders)); }
    function resetForm() {
        document.getElementById('dispID').innerText = 'ORD-' + Math.floor(Math.random()*900000+100000);
        document.getElementById('cName').value = ''; document.getElementById('cPhone').value = ''; document.getElementById('cCity').value = '';
        document.getElementById('iDisc').value = 0; document.getElementById('iPack').value = 0;
        document.getElementById('oDate').valueAsDate = new Date();
        document.getElementById('billBody').innerHTML = ''; addRow(); calc();
    }
    function addRow(d={code:'', name:'', qty:1, rate:0}) {
        let tr = document.createElement('tr');
        tr.innerHTML = `<td><small style="color:#64748b">${d.code}</small><br><input class="r-name" value="${d.name}"></td><td><input type="number" class="r-qty" value="${d.qty}" oninput="calc()"></td><td><input type="number" class="r-rate" value="${d.rate}" oninput="calc()"></td><td class="r-tot" style="font-weight:bold;">0</td><td><button onclick="this.closest('tr').remove();calc()" style="color:red; background:none; border:none; font-size:22px;">√ó</button></td>`;
        document.getElementById('billBody').appendChild(tr); calc();
    }
    function calc() {
        let q=0, t=0;
        document.querySelectorAll('#billBody tr').forEach(r => {
            let nq = +r.querySelector('.r-qty').value || 0, nr = +r.querySelector('.r-rate').value || 0;
            let nt = nq * nr; r.querySelector('.r-tot').innerText = nt; q += nq; t += nt;
        });
        let grand = t - (+document.getElementById('iDisc').value || 0) + (+document.getElementById('iPack').value || 0);
        document.getElementById('oQty').innerText = q; document.getElementById('oGrand').innerText = grand.toLocaleString('en-IN');
    }
    function addItem() {
        let n = document.getElementById('nItem').value, r = document.getElementById('nRate').value, s = document.getElementById('nSize').value;
        if(!n || !r) return alert("Enter Name/Rate");
        if(editingItemCode) {
            let i = db.findIndex(x => x.code === editingItemCode);
            db[i] = { code: editingItemCode, name: n, size: s, rate: r };
            editingItemCode = null; document.getElementById('btnSaveItem').innerText = "ADD/UPDATE";
        } else {
            db.push({code: Math.random().toString(36).substr(2,6).toUpperCase(), name: n, size: s, rate: r});
        }
        sync(); renderMgr(); document.getElementById('nItem').value = ''; document.getElementById('nRate').value = ''; document.getElementById('nSize').value = '';
    }
    function renderMgr() {
        document.getElementById('mgrList').innerHTML = db.map((i,idx) => `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee;"><div><b>${i.name}</b><br><small>‚Çπ${i.rate} | ${i.code}</small></div><div><button class="edit-btn" onclick="editItem('${i.code}')">EDIT</button><button class="del-btn" onclick="if(confirm('Delete?')){db.splice(${idx},1);sync();renderMgr()}">DEL</button></div></div>`).join('');
    }
    function editItem(code) {
        let itm = db.find(x => x.code === code);
        document.getElementById('nItem').value = itm.name; document.getElementById('nSize').value = itm.size; document.getElementById('nRate').value = itm.rate;
        editingItemCode = code; document.getElementById('btnSaveItem').innerText = "UPDATE NOW";
    }
    function filterHist(val) {
        let filtered = orders.filter(o => o.name.toLowerCase().includes(val.toLowerCase()) || o.id.toLowerCase().includes(val.toLowerCase()));
        document.getElementById('histList').innerHTML = filtered.map(o => `<div style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;"><div><b>${o.name}</b><br><small>${o.id} | ‚Çπ${o.total}</small></div><div><button class="edit-btn" onclick="loadOrder('${o.id}')">EDIT</button><button class="del-btn" onclick="if(confirm('Delete?')){orders=orders.filter(x=>x.id!=='${o.id}');sync();filterHist('${val}')}">DEL</button></div></div>`).join('');
    }
    function loadOrder(id) {
        let o = orders.find(x => x.id === id);
        document.getElementById('dispID').innerText = o.id; document.getElementById('cName').value = o.name; document.getElementById('cPhone').value = o.phone || ''; document.getElementById('cCity').value = o.city || '';
        document.getElementById('oDate').value = o.date; document.getElementById('iDisc').value = o.disc || 0; document.getElementById('iPack').value = o.pack || 0;
        document.getElementById('billBody').innerHTML = ''; o.items.forEach(i => addRow(i)); calc(); closeM('modalHist');
    }
    function saveOrder() {
        let items = [];
        document.querySelectorAll('#billBody tr').forEach(r => { if(r.querySelector('.r-name').value) items.push({name: r.querySelector('.r-name').value, qty: r.querySelector('.r-qty').value, rate: r.querySelector('.r-rate').value}); });
        let order = { id: document.getElementById('dispID').innerText, date: document.getElementById('oDate').value, name: document.getElementById('cName').value, phone: document.getElementById('cPhone').value, city: document.getElementById('cCity').value, disc: document.getElementById('iDisc').value, pack: document.getElementById('iPack').value, items, total: document.getElementById('oGrand').innerText };
        let idx = orders.findIndex(o => o.id === order.id); if(idx > -1) orders[idx] = order; else orders.unshift(order);
        sync(); alert("Saved!");
    }
    function sendWA() {
        let n = document.getElementById('cName').value; let p = document.getElementById('cPhone').value; if(!n) return alert("Enter Name");
        let subtotal = 0; let itxt = ""; 
        document.querySelectorAll('#billBody tr').forEach(r => { 
            let nm = r.querySelector('.r-name').value; let q = r.querySelector('.r-qty').value; let rt = r.querySelector('.r-rate').value;
            if(nm) { itxt += `%0A‚Ä¢ *${nm}* (${q} x ${rt})`; subtotal += (q * rt); }
        });
        let msg = `*DEEP TRADERS : BY DHALIWAL*%0AOrder: ${document.getElementById('dispID').innerText}%0A*Party:* ${n}%0A*Details:*${itxt}%0A----------------------------%0ASubtotal: ‚Çπ${subtotal}%0ADiscount: -‚Çπ${document.getElementById('iDisc').value}%0APacking: +‚Çπ${document.getElementById('iPack').value}%0A*GRAND TOTAL: ‚Çπ${document.getElementById('oGrand').innerText}*`;
        window.open(`https://wa.me/${p.startsWith('91') ? p : '91' + p}?text=${msg}`);
    }
    function printStickers() {
        let area = document.getElementById('print-labels-area'); area.innerHTML = db.map(i => `<div class="sticker"><b>${i.name}</b><svg class="barcode-img" jsbarcode-value="${i.code}"></svg><span>Size: ${i.size} | ‚Çπ${i.rate}</span></div>`).join('');
        JsBarcode(".barcode-img", { format: "CODE128", height: 35, width: 2, displayValue: true, fontSize: 14 }).init();
        document.body.className = 'print-labels'; window.print(); setTimeout(() => document.body.className = '', 500);
    }
    function printBill() {
        let body = Array.from(document.querySelectorAll('#billBody tr')).map(r => `<tr><td>${r.querySelector('.r-name').value}</td><td>${r.querySelector('.r-qty').value}</td><td>${r.querySelector('.r-rate').value}</td><td>${r.querySelector('.r-tot').innerText}</td></tr>`).join('');
        document.getElementById('print-receipt-area').innerHTML = `<div style="text-align:center;"><h2>Deep Traders : By Dhaliwal</h2><p>Ludhiana | 97796-79885</p></div><p>Party: ${document.getElementById('cName').value}<br>Date: ${document.getElementById('oDate').value}</p><table border="1" style="width:100%; border-collapse:collapse;"><thead><tr><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th></tr></thead><tbody>${body}</tbody></table><h3 style="text-align:right;">Total: ‚Çπ ${document.getElementById('oGrand').innerText}</h3>`;
        document.body.className = 'print-receipt'; window.print(); setTimeout(() => document.body.className = '', 500);
    }
    function openHist() { document.getElementById('modalHist').style.display='flex'; filterHist(''); }
    function openMgr() { document.getElementById('modalMgr').style.display='flex'; renderMgr(); }
    function openPick() { document.getElementById('modalPick').style.display='flex'; document.getElementById('pickList').innerHTML = db.map(i => `<div onclick="addRow({code:'${i.code}', name:'${i.name}', qty:1, rate:'${i.rate}'});closeM('modalPick')" style="padding:15px; border-bottom:1px solid #eee; cursor:pointer;">${i.name} - ‚Çπ${i.rate}</div>`).join(''); }
    function openData() { document.getElementById('modalData').style.display='flex'; }
    function closeM(id) { document.getElementById(id).style.display='none'; editingItemCode = null; }
    let scanner = null;
    function startScan() { document.getElementById('modalScan').style.display='flex'; if(!scanner) { scanner = new Html5QrcodeScanner("scanBox", { fps: 15, qrbox: 250 }); scanner.render(res => { let itm = db.find(i => i.code === res); if(itm) addRow({code: itm.code, name: itm.name, qty: 1, rate: itm.rate}); }); } }
    function stopScan() { document.getElementById('modalScan').style.display='none'; if(scanner) { scanner.clear(); scanner=null; } }
    resetForm();
</script>
</body>
</html>
